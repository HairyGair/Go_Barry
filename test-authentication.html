<!DOCTYPE html>
<html>
<head>
    <title>BARRY Authentication Test</title>
    <style>
        body { 
            font-family: 'SF Mono', monospace; 
            margin: 20px; 
            background: #0a0a0a; 
            color: #00ff00; 
        }
        .container { max-width: 600px; margin: 0 auto; }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid;
        }
        .success { background: #0a2e0a; border-color: #00ff00; }
        .error { background: #2e0a0a; border-color: #ff0000; }
        .warning { background: #2e2e0a; border-color: #ffaa00; }
        .info { background: #0a0a2e; border-color: #0088ff; }
        
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            background: #1a1a1a; 
            color: #00ff00; 
            border: 2px solid #00ff00; 
            border-radius: 6px; 
            cursor: pointer; 
            font-family: inherit;
        }
        button:hover { background: #00ff00; color: #000; }
        
        #log { 
            height: 400px; 
            overflow-y: auto; 
            border: 2px solid #333; 
            padding: 15px; 
            background: #000; 
            border-radius: 6px;
            font-size: 13px;
        }
        
        .timestamp { color: #666; }
        .success-msg { color: #00ff00; }
        .error-msg { color: #ff4444; }
        .info-msg { color: #44aaff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê BARRY Authentication Test</h1>
        
        <div id="status" class="status warning">
            ‚è≥ Ready to test authentication
        </div>

        <div>
            <button onclick="testBackendAuth()">Test Backend Authentication</button>
            <button onclick="testWebSocketFlow()">Test Full WebSocket Flow</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div id="log"></div>
    </div>

    <script>
        const API_BASE = 'https://go-barry.onrender.com';
        const WS_URL = 'wss://go-barry.onrender.com/ws/supervisor-sync';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type + '-msg';
            
            logDiv.innerHTML += `<div><span class="timestamp">[${timestamp}]</span> <span class="${className}">${message}</span></div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function testBackendAuth() {
            log('üîê Testing backend authentication...', 'info');
            updateStatus('Testing backend authentication...', 'warning');
            
            try {
                // Test authentication with one of our supervisors
                const response = await fetch(`${API_BASE}/api/supervisor/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        supervisorId: 'supervisor001',
                        badge: 'AW001'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`‚úÖ Backend authentication successful!`, 'success');
                    log(`üìã Session ID: ${data.sessionId}`, 'info');
                    log(`üë§ Supervisor: ${data.supervisor.name}`, 'info');
                    updateStatus('‚úÖ Backend authentication working', 'success');
                    
                    // Store session for WebSocket test
                    window.testSessionId = data.sessionId;
                    window.testSupervisorId = 'supervisor001';
                    
                } else {
                    log(`‚ùå Backend authentication failed: ${data.error}`, 'error');
                    updateStatus('‚ùå Backend authentication failed', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Backend authentication error: ${error.message}`, 'error');
                updateStatus('‚ùå Backend authentication error', 'error');
            }
        }

        async function testWebSocketFlow() {
            if (!window.testSessionId) {
                log('‚ùå No session ID - run backend auth test first', 'error');
                return;
            }
            
            log('üîå Testing full WebSocket authentication flow...', 'info');
            updateStatus('Testing WebSocket flow...', 'warning');
            
            const ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                log('‚úÖ WebSocket connected', 'success');
                
                // Send auth message with real session
                const authMessage = {
                    type: 'auth',
                    clientType: 'supervisor',
                    supervisorId: window.testSupervisorId,
                    sessionId: window.testSessionId,
                    timestamp: new Date().toISOString()
                };
                
                ws.send(JSON.stringify(authMessage));
                log('üì§ Sent supervisor auth message', 'info');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log(`üì® Received: ${data.type}`, 'success');
                
                if (data.type === 'auth_success') {
                    log('üéâ WebSocket authentication successful!', 'success');
                    log(`üë• Connected displays: ${data.connectedDisplays}`, 'info');
                    updateStatus('‚úÖ Full authentication flow working!', 'success');
                    
                    // Test sending a broadcast message
                    setTimeout(() => {
                        const testMessage = {
                            type: 'broadcast_message',
                            message: 'Test message from authenticated supervisor',
                            priority: 'info',
                            duration: 10000
                        };
                        ws.send(JSON.stringify(testMessage));
                        log('üì§ Sent test broadcast message', 'info');
                    }, 1000);
                    
                } else if (data.type === 'auth_failed') {
                    log(`‚ùå WebSocket auth failed: ${data.error}`, 'error');
                    updateStatus('‚ùå WebSocket authentication failed', 'error');
                } else if (data.type === 'welcome') {
                    log(`üëã WebSocket welcomed with client ID: ${data.clientId}`, 'info');
                }
            };

            ws.onerror = (error) => {
                log('‚ùå WebSocket error', 'error');
                updateStatus('‚ùå WebSocket connection error', 'error');
            };

            ws.onclose = (event) => {
                log(`üîå WebSocket closed: Code ${event.code}`, 'info');
                if (event.code === 1008) {
                    log('üö® Rate limit hit - connection rejected', 'error');
                }
            };

            // Clean up after 30 seconds
            setTimeout(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.close();
                    log('üîå Test connection closed', 'info');
                }
            }, 30000);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            updateStatus('Ready to test authentication', 'warning');
        }

        // Auto-start
        window.onload = () => {
            log('üîê BARRY Authentication Test Ready', 'success');
            log('üí° Click "Test Backend Authentication" to start', 'info');
        };
    </script>
</body>
</html>
