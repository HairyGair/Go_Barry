        const NORTH_EAST_BOUNDS = {
            center: [54.9783, -1.6178],
            bounds: [[53.5, -3.0], [56.0, -0.5]],
            zoom: 12
        };

        // Supervisor data structure (no badge numbers)
        const supervisorRoles = {
            'anthony-gair': { name: 'Anthony Gair', role: 'Service Delivery Supervisor' },
            'andrew-cowley': { name: 'Andrew Cowley', role: 'Service Delivery Supervisor' },
            'claire-fiddler': { name: 'Claire Fiddler', role: 'Service Delivery Supervisor' },
            'alex-woodcock': { name: 'Alex Woodcock', role: 'Service Delivery Supervisor' },
            'john-paterson': { name: 'John Paterson', role: 'Service Delivery Supervisor' },
            'simon-glass': { name: 'Simon Glass', role: 'Service Delivery Supervisor' },
            'david-hall': { name: 'David Hall', role: 'Service Delivery Supervisor' },
            'james-daglish': { name: 'James Daglish', role: 'Service Delivery Supervisor' },
            'barry-perryman': { name: 'Barry Perryman', role: 'Service Delivery Controller' }
        };

        let activeSupervisors = [];

        // Initialize map
        function initializeMap() {
            console.log('üó∫Ô∏è Initializing enhanced display map...');
            
            map = L.map('map').setView(NORTH_EAST_BOUNDS.center, NORTH_EAST_BOUNDS.zoom);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap | BARRY Traffic Intelligence',
                maxZoom: 18
            }).addTo(map);

            // Add boundary highlight
            const boundary = L.rectangle(NORTH_EAST_BOUNDS.bounds, {
                color: '#3b82f6',
                weight: 2,
                opacity: 0.4,
                fillColor: '#3b82f6',
                fillOpacity: 0.05
            }).addTo(map);

            // Update map info on zoom/move
            map.on('zoomend moveend', updateMapInfo);
            
            console.log('‚úÖ Enhanced display map ready');
        }

        function updateMapInfo() {
            document.getElementById('map-zoom-info').textContent = `Zoom: ${map.getZoom()}`;
            const center = map.getCenter();
            document.getElementById('map-center-info').textContent = 
                `${center.lat.toFixed(3)}, ${center.lng.toFixed(3)}`;
        }

        // Clear existing markers
        function clearMapMarkers() {
            alertMarkers.forEach(marker => map.removeLayer(marker));
            alertMarkers = [];
        }

        // Add alert markers to map
        function addAlertToMap(alert, index) {
            if (!alert.coordinates || alert.coordinates.length !== 2) return;

            const [lat, lng] = alert.coordinates;
            
            const iconColor = alert.severity === 'High' ? '#ef4444' : 
                            alert.severity === 'Medium' ? '#f59e0b' : '#10b981';
            
            const customIcon = L.divIcon({
                className: 'custom-alert-marker',
                html: `<div style="
                    background: ${iconColor};
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 12px;
                ">!</div>`,
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });

            const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
            alertMarkers.push(marker);
        }

        // Create compact alert item
        function createAlertItem(alert, index) {
            const routeBadges = alert.affectsRoutes && alert.affectsRoutes.length > 0
                ? alert.affectsRoutes.map(route => `<span class="route-badge">${route}</span>`).join('')
                : '';
            
            const startTime = alert.startDate ? new Date(alert.startDate).toLocaleString('en-GB', {
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit'
            }) : 'Unknown';
            
            const severityClass = alert.severity ? `severity-${alert.severity.toLowerCase()}` : 'severity-low';
            const authority = alert.authority || alert.source || 'Unknown';
            
            return `
                <div class="alert-item ${severityClass}" data-index="${index}" onclick="selectAlert(${index})">
                    <div class="alert-header">
                        <div class="alert-title">${alert.title || 'Traffic Alert'}</div>
                        <div class="alert-time">${startTime}</div>
                    </div>
                    <div class="alert-location">
                        <i class="fas fa-map-marker-alt"></i>
                        ${alert.location || 'Location not specified'}
                    </div>
                    <div class="alert-description">${(alert.description || 'Traffic incident reported').substring(0, 120)}${alert.description && alert.description.length > 120 ? '...' : ''}</div>
                    <div class="alert-meta">
                        <div class="route-badges">${routeBadges}</div>
                        <div>
                            <span class="severity-indicator ${severityClass}"></span>
                            ${authority}
                        </div>
                    </div>
                </div>
            `;
        }

        // Select alert and focus map
        function selectAlert(index) {
            // Remove previous selection
            document.querySelectorAll('.alert-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            const selectedItem = document.querySelector(`[data-index="${index}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
                selectedAlertIndex = index;
                
                // Focus map on alert if it has coordinates
                const alert = currentAlerts[index];
                if (alert && alert.coordinates && alert.coordinates.length === 2) {
                    const [lat, lng] = alert.coordinates;
                    map.setView([lat, lng], 16, { animate: true, duration: 1 });
                }
            }
        }

        // Enhanced alert fetching
        async function fetchAlerts() {
            try {
                console.log('üöÄ Fetching alerts for enhanced display...');
                const response = await fetch(`${API_BASE_URL}/api/alerts-enhanced`);
                const data = await response.json();
                
                if (data.success && data.alerts) {
                    currentAlerts = data.alerts;
                    updateAlertsDisplay(currentAlerts);
                    updateMapWithAlerts(currentAlerts);
                    updateAnalytics(data.metadata);
                    
                    // Update last update time
                    const lastUpdate = document.getElementById('last-update');
                    lastUpdate.textContent = `Last Update: ${new Date().toLocaleTimeString('en-GB', { 
                        hour12: false, 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })}`;
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('‚ùå Error fetching alerts:', error);
                showErrorState();
            }
        }

        // Fetch supervisors data
        async function fetchSupervisors() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/supervisor/active`);
                if (response.ok) {
                    const data = await response.json();
                    activeSupervisors = data.activeSupervisors || [];
                    updateSupervisorDisplay(activeSupervisors);
                    updateSupervisorIndicator(activeSupervisors);
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è Supervisor API not available');
                activeSupervisors = [];
                updateSupervisorDisplay([]);
                updateSupervisorIndicator([]);
            }
        }

        // Update supervisor display with logged in supervisors
        function updateSupervisorDisplay(supervisors) {
            const count = supervisors.length;
            document.getElementById('header-supervisors').textContent = count;
        }

        // Update supervisor indicator to show who's logged in
        function updateSupervisorIndicator(supervisors) {
            // Create or update supervisor status display
            let supervisorStatus = document.getElementById('supervisor-status');
            if (!supervisorStatus) {
                supervisorStatus = document.createElement('div');
                supervisorStatus.id = 'supervisor-status';
                supervisorStatus.style.cssText = `
                    position: absolute;
                    top: 90px;
                    right: 24px;
                    background: rgba(17, 24, 39, 0.9);
                    backdrop-filter: blur(10px);
                    border-radius: 12px;
                    padding: 12px 16px;
                    min-width: 250px;
                    z-index: 1000;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    max-height: 200px;
                    overflow-y: auto;
                `;
                document.body.appendChild(supervisorStatus);
            }

            if (supervisors.length === 0) {
                supervisorStatus.innerHTML = `
                    <div style="color: #9ca3af; font-size: 12px; text-align: center;">
                        <i class="fas fa-user-slash" style="margin-right: 6px;"></i>
                        No supervisors logged in
                    </div>
                `;
                return;
            }

            // Group supervisors by role
            const controllers = supervisors.filter(s => {
                const supervisorData = supervisorRoles[s.id] || supervisorRoles[s.supervisorId];
                return supervisorData && supervisorData.role === 'Service Delivery Controller';
            });

            const supervisorsList = supervisors.filter(s => {
                const supervisorData = supervisorRoles[s.id] || supervisorRoles[s.supervisorId];
                return supervisorData && supervisorData.role === 'Service Delivery Supervisor';
            });

            let statusHtml = '<div style="font-size: 14px; font-weight: 600; color: #ffffff; margin-bottom: 8px;">Logged In Supervisors</div>';

            // Show controllers first
            if (controllers.length > 0) {
                statusHtml += '<div style="margin-bottom: 6px;">';
                controllers.forEach(supervisor => {
                    const supervisorData = supervisorRoles[supervisor.id] || supervisorRoles[supervisor.supervisorId];
                    const name = supervisorData ? supervisorData.name : (supervisor.name || supervisor.id);
                    statusHtml += `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; color: #10b981;">
                            <i class="fas fa-crown" style="font-size: 12px;"></i>
                            <span style="font-size: 12px; font-weight: 600;">${name}</span>
                            <span style="font-size: 10px; color: #6ee7b7;">(Controller)</span>
                        </div>
                    `;
                });
                statusHtml += '</div>';
            }

            // Show supervisors
            if (supervisorsList.length > 0) {
                supervisorsList.forEach(supervisor => {
                    const supervisorData = supervisorRoles[supervisor.id] || supervisorRoles[supervisor.supervisorId];
                    const name = supervisorData ? supervisorData.name : (supervisor.name || supervisor.id);
                    statusHtml += `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; color: #3b82f6;">
                            <i class="fas fa-user-check" style="font-size: 12px;"></i>
                            <span style="font-size: 12px; font-weight: 500;">${name}</span>
                        </div>
                    `;
                });
            }

            supervisorStatus.innerHTML = statusHtml;
        }

        // Update map with current alerts
        function updateMapWithAlerts(alerts) {
            clearMapMarkers();
            
            const mappableAlerts = alerts.filter(alert => 
                alert.coordinates && alert.coordinates.length === 2
            );
            
            mappableAlerts.forEach((alert, index) => {
                addAlertToMap(alert, alerts.indexOf(alert));
            });
            
            // Update header with map alerts count
            document.getElementById('header-map-alerts').textContent = mappableAlerts.length;
            
            console.log(`üó∫Ô∏è Added ${mappableAlerts.length} alerts to map`);
        }

        // Update header analytics display
        function updateAnalytics(metadata) {
            const criticalCount = currentAlerts.filter(a => a.severity === 'High').length;
            const affectedRoutesCount = new Set(currentAlerts.flatMap(a => a.affectsRoutes || [])).size;
            const mappableAlerts = currentAlerts.filter(alert => 
                alert.coordinates && alert.coordinates.length === 2
            ).length;
            
            // Update header metrics
            document.getElementById('header-total-alerts').textContent = currentAlerts.length;
            document.getElementById('header-critical').textContent = criticalCount;
            document.getElementById('header-routes').textContent = affectedRoutesCount;
            document.getElementById('header-map-alerts').textContent = mappableAlerts;
            document.getElementById('alert-count').textContent = currentAlerts.length;
        }

        function showErrorState() {
            const alertsContainer = document.getElementById('alerts-container');
            alertsContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 16px; color: var(--status-warning);"></i>
                    <h3 style="font-size: 16px; margin-bottom: 8px;">Connection Error</h3>
                    <p style="font-size: 12px;">Unable to fetch traffic alerts</p>
                </div>
            `;
        }

        // Update alerts display with compact list
        function updateAlertsDisplay(alerts) {
            const alertsContainer = document.getElementById('alerts-container');
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = `
                    <div class="no-alerts">
                        <i class="fas fa-shield-check"></i>
                        <h3 style="font-size: 16px; margin-bottom: 8px;">All Clear</h3>
                        <p style="font-size: 12px;">No active traffic alerts</p>
                    </div>
                `;
                return;
            }
            
            // Sort alerts by severity and time
            const sortedAlerts = alerts.sort((a, b) => {
                const severityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                const aSeverity = severityOrder[a.severity] || 1;
                const bSeverity = severityOrder[b.severity] || 1;
                
                if (aSeverity !== bSeverity) {
                    return bSeverity - aSeverity; // High severity first
                }
                
                // Then by time (newest first)
                const aTime = a.startDate ? new Date(a.startDate) : new Date(0);
                const bTime = b.startDate ? new Date(b.startDate) : new Date(0);
                return bTime - aTime;
            });
            
            const alertsHtml = sortedAlerts.map((alert, index) => createAlertItem(alert, index)).join('');
            alertsContainer.innerHTML = alertsHtml;
            
            // Auto-select first critical alert or first alert
            const firstCritical = sortedAlerts.findIndex(a => a.severity === 'High');
            const autoSelectIndex = firstCritical >= 0 ? firstCritical : 0;
            if (autoSelectIndex >= 0) {
                setTimeout(() => selectAlert(autoSelectIndex), 100);
            }
        }

        // Clock update
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-GB', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('clock').textContent = timeString;
        }

        // Initialize everything
        function init() {
            console.log('üö¶ BARRY Enhanced Control Room Display Initializing...');
            
            initializeMap();
            updateClock();
            setInterval(updateClock, 1000);
            fetchAlerts();
            fetchSupervisors();
            setInterval(fetchAlerts, 30000); // 30 seconds
            setInterval(fetchSupervisors, 15000); // 15 seconds - more frequent for supervisor updates
            
            console.log('‚úÖ Enhanced Control Room Display Ready');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', init);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
                event.preventDefault();
                fetchAlerts();
            }
            
            // Arrow keys to navigate alerts
            if (event.key === 'ArrowUp' && selectedAlertIndex > 0) {
                selectAlert(selectedAlertIndex - 1);
            }
            if (event.key === 'ArrowDown' && selectedAlertIndex < currentAlerts.length - 1) {
                selectAlert(selectedAlertIndex + 1);
            }
        });
    </script>
</body>
</html>